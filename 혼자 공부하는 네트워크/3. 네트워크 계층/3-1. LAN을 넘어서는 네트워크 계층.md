# 3-1. LAN을 넘어서는 네트워크 계층

LAN을 넘어서는 다른 네트워크와 통신하기 위해서는 **네트워크 계층**의 역할이 필수적이다.

## 데이터 링크 계층의 한계

데이터 링크 계층에는 MAC 주소의 개념이 있으나 LAN보다 큰 규모의 네트워크와 통신이 불가능하다.
→ 2가지 이유

- 라우터가 없기 때문에, 다른 네트워크까지 도달 경로(최적의 경로)를 파악할 수 없음
- MAC 주소(수신인 특정)만으로는 호스트의 위치를 특정할 수 없음
  - IP 주소(수신지 특정)가 필요

네트워크에서는 MAC 주소와 IP 주소를 함께 사용하고, IP 주소를 우선적으로 활용한다.

<hr>

## 인터넷 프로토콜(IP 프로토콜)

네트워크 계층의 가장 핵심적인 프로토콜로, IPv4와 IPv6가 있으나 주로 IPv4를 지칭한다.

### IP 프로토콜의 기능

#### 주소 지정
> IP 주소를 바탕으로 송수신 대상을 지정하는 것

#### 단편화
> MTU(한 번에 전송 가능한 IP 패킷의 최대 크기)만큼 복수의 패킷으로 나누는 것

단편화된 패킷들은 수신지에 도착하면 재조립된다.

### IPv4의 핵심 필드
> 4바이트(32비트), 숫자당 8비트로 표현, 0~255 범위의 10진수의 4개 그룹

- **식별자**
  - 패킷에 할당된 번호
  - 어떤 메시지에서부터 쪼개졌는지 인식하기 위해 사용함 
- **플래그**
  - 첫 번째 피트: 0
  - 두 번째 피트: DF(Don't Fragment)
  - 세 번째 비트: MF(More Fragment)
- **단편화 오프셋**
  - 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지 나타냄 (순서)
  - 단편화된 패킷들을 재조립할 때 순서대로 조립하기 위해 사용함
- **TTL(Time To Live)**
  - 패킷의 수명
  - 패킷이 하나의 라우터(홉)을 거칠 때마다 1씩 감소함
  - TTL의 값이 0이 되면 패킷은 폐기됨
  - 무의미한 패킷이 네트워크상 남아있는 것을 방지하기 위함
- **프로토콜**
  - 상위 계층의 프로토콜이 무엇인지 나타내는 필드
- **송신지 IP 주소 & 수신지 IP 주소**
  - 송수신지의 IPv4 주소

### IPv6의 핵심 필드
> IPv4 주소의 고갈 문제를 해결하기 위해 등장한 것으로, 16바이트(128비트), 16진수의 8개 그룹

- **다음 헤더**
  - 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리킴
- **홉 제한**
  - 패킷의 수명을 나타냄
- **송신지 IP 주소 & 수신지 IP 주소**
  - 송수신지의 IPv6 주소

<hr>

## ARP
> **동일 네트워크** 내에 있는 호스트의 IP 주소를 통해 MAC 주소를 알아내는 프로토콜

MAC 주소와 IP 주소는 기본적으로 함께 사용된다. 하지만 IP 주소만 알고 MAC 주소는 모른다면?
이 때 사용하는 것이 ARP 프로토콜이다.

### ARP의 동작 과정

#### 1) ARP 요청
> 호스트 내의 모든 호스트에게 브로드캐스트 메시지를 보냄

#### 2) ARP 응답
> 수신받은 IP 주소와 자신의 IP 주소가 일치하면, 자신의 MAC 주소를 반환함

#### 3) ARP 테이블 갱신
> ARP 테이블의 IP 주소와 MAC 주소의 연관관계를 갱신함

<hr>

## IP 단편화 피하는 방법

IP 단편화는 적게 수행될수록 좋다. 

### 경로 MTU
> IP 단편화 없이 주고받을 수 있는 최대 크기

### 경로 MTU 발견
> 경로 MTU를 이용해서 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술